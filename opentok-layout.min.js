/*!
 *  opentok-layout-js (http://github.com/aullman/opentok-layout-js)
 *
 *  Automatic layout of video elements (publisher and subscriber) minimising
 *  white-space for the OpenTok on WebRTC API.
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
 **/
if("undefined"==typeof module||"undefined"==typeof module.exports)exports=window;else var window=null;!function(t){var i=function(i,e,a,o,n,r){var g={left:e+"px",top:a+"px",width:o+"px",height:n+"px"},d=function(){var t=i.querySelector(".OT_root");if(t){var e=t.style.width;t.style.width=o+"px",t.style.width=e||""}};r&&t?(t(i).stop(),t(i).animate(g,r.duration||200,r.easing||"swing",function(){d(),r.complete&&r.complete.call(this)})):OT.$.css(i,g),d()},e=function(t,i){var e=OT.$.css(t,i);return e?parseInt(e,10):0},a=function(){return(1e8*Math.random()).toFixed(0)},o=function(t){var i=OT.$.height(t);return i?parseInt(i,10):0},n=function(t){var i=OT.$.width(t);return i?parseInt(i,10):0},r=function(t,a,o,n,r,g,d,l,s,p){var h,m=t.length,R=function(t,i){for(var e,n,r,g,d,l,s,p,R=1;m>=R;R++){var f=R,u=Math.ceil(m/f);s=Math.floor(o/u),l=Math.floor(a/f),p=s/l,p>i?(p=i,s=l*p):t>p&&(p=t,l=s/p);var b=l*s*m;(void 0===e||b>e)&&(e=b,g=s,d=l,n=f,r=u)}return{maxArea:e,targetCols:n,targetRows:r,targetHeight:g,targetWidth:d,ratio:h}};if(g){var f=t.length>0&&t[0].querySelector("video");h=f&&f.videoHeight&&f.videoWidth?R(f.videoHeight/f.videoWidth,f.videoHeight/f.videoWidth):R(.75,.75)}else h=R(d,l);var u=h.targetRows*h.targetCols-m,b=u*h.targetWidth/2,v=(h.targetRows-1)*h.targetCols,x=(o-h.targetRows*h.targetHeight)/2,c=(a-h.targetCols*h.targetWidth)/2;p&&h.targetHeight*h.targetRows<o&&(x=0);for(var T=0,M=0,y=0;y<t.length;y++){var w=t[y];y%h.targetCols===0?(T=c,y==v&&(T+=b),M+=0===y?x:h.targetHeight):T+=h.targetWidth,OT.$.css(w,"position","absolute");var O=h.targetWidth-e(w,"paddingLeft")-e(w,"paddingRight")-e(w,"marginLeft")-e(w,"marginRight")-e(w,"borderLeft")-e(w,"borderRight"),H=h.targetHeight-e(w,"paddingTop")-e(w,"paddingBottom")-e(w,"marginTop")-e(w,"marginBottom")-e(w,"borderTop")-e(w,"borderBottom");i(w,T+n,M+r,O,H,s)}},g=function(t){return"none"!==OT.$.css(t,"display")},d=function(t,i,d){if("none"!==OT.$.css(t,"display")){var l=t.getAttribute("id");l||(l="OT_"+a(),t.setAttribute("id",l));var s=o(t)-e(t,"borderTop")-e(t,"borderBottom"),p=n(t)-e(t,"borderLeft")-e(t,"borderRight"),h=s/p,m=0,R=0,f=0,u=0,b=0,v=Array.prototype.filter.call(t.querySelectorAll("#"+l+">."+i.bigClass),g),x=Array.prototype.filter.call(t.querySelectorAll("#"+l+">*:not(."+i.bigClass+")"),g);if(v.length>0&&x.length>0){var c=v[0].querySelector("video");b=c&&c.videoHeight&&c.videoWidth?c.videoHeight/c.videoWidth:.75;var T,M;i.presentationMode==presentationMode.HANGOUT||i.presentationMode!=presentationMode.PIP&&h>b?(T=p,M=Math.min(Math.floor(s*i.bigPercentage),p*b),R=M,f=s-R):(M=s,T=Math.min(p*i.bigPercentage,Math.floor(M/b)),m=T,u=p-m),i.bigFirst?i.smallBottom?(r(x,p-m,s-R,m,R,i.fixedRatio,i.minRatio,i.maxRatio,i.animate,i.alignTop),r(v,T,M,0,0,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate,i.alignTop)):(r(x,p-m,s-R,m,0,i.fixedRatio,i.minRatio,i.maxRatio,i.animate,i.alignTop),r(v,T,M,0,f,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate,i.alignTop)):i.smallBottom?(r(v,T,M,u,0,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate,i.alignTop),r(x,p-m,s-R,0,R,i.fixedRatio,i.minRatio,i.maxRatio,i.animate,i.alignTop)):(r(v,T,M,u,f,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate,i.alignTop),r(x,p-m,s-R,0,0,i.fixedRatio,i.minRatio,i.maxRatio,i.animate,i.alignTop))}else v.length>0&&0===x.length?r(v,p,s,0,0,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate,i.alignTop):r(x,p-m,s-R,m,R,i.fixedRatio,i.minRatio,i.maxRatio,i.animate,i.alignTop)}};exports.initLayoutContainer=function(t,i){return i=OT.$.defaults(i||{},{maxRatio:1.5,minRatio:9/16,fixedRatio:!1,animate:!1,bigClass:"OT_big",bigPercentage:.8,bigFixedRatio:!1,bigMaxRatio:1.5,bigMinRatio:9/16,bigFirst:!0,smallBottom:!1,alignTop:!1,presentationMode:0}),presentationMode={AUTO:0,HANGOUT:1,PIP:2},t="string"==typeof t?OT.$(t):t,OT.onLoad(function(){d(t,i)}),{layout:d.bind(null,t,i),opts:i}}}(window&&window.hasOwnProperty("jQuery")?jQuery:void 0);